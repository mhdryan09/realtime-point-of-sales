# 5. State Management Zustand

## Recap Perubahan

### 1. Instalasi Zustand

**Langkah:**
Melakukan instalasi package Zustand untuk state management:

```bash
npm install zustand@5.0.6
```

### 2. Membuat Auth Store

**Langkah:**
Membuat store untuk authentication di `src/stores/auth-store.ts`:

```typescript
import { create } from "zustand";
import { User } from "@supabase/supabase-js";
import { Profile } from "@/types/auth";
import { INITIAL_STATE_PROFILE } from "@/constants/auth-constant";

type AuthState = {
  user: User | null;
  profile: Profile;
  setUser: (user: User | null) => void;
  setProfile: (profile: Profile) => void;
};

export const useAuthStore = create<AuthState>((set) => ({
  user: null,
  profile: INITIAL_STATE_PROFILE,
  setUser: (user) => set({ user }),
  setProfile: (profile) => set({ profile }),
}));
```

**Penjelasan:**

- **Zustand Store**: Menggunakan `create()` untuk membuat store
- **TypeScript Types**: Mendefinisikan type `AuthState` untuk type safety
- **State Properties**: `user` dan `profile` untuk menyimpan data authentication
- **Setter Functions**: `setUser` dan `setProfile` untuk update state
- **Initial State**: Default nilai user null dan profile dari constant

#### **Penjelasan Script Kompleks:**

**1. Zustand Store Creation:**

```typescript
export const useAuthStore = create<AuthState>((set) => ({
  user: null,
  profile: INITIAL_STATE_PROFILE,
  setUser: (user) => set({ user }),
  setProfile: (profile) => set({ profile }),
}));
```

- `create<AuthState>`: Membuat store dengan TypeScript type yang sudah ditentukan
- `(set) =>`: Parameter `set` adalah fungsi untuk update state
- `set({ user })`: Shorthand untuk `set({ user: user })` update property user
- **Immer Integration**: Zustand otomatis menggunakan immer untuk immutable updates

**2. TypeScript Interface:**

```typescript
type AuthState = {
  user: User | null;
  profile: Profile;
  setUser: (user: User | null) => void;
  setProfile: (profile: Profile) => void;
};
```

- `User | null`: Union type, user bisa berisi object User atau null
- `Profile`: Custom type dari auth-constant untuk user profile
- Function signatures: Definisi parameter dan return type untuk setter functions

### 3. Membuat Auth Store Provider

**Langkah:**
Membuat provider untuk inisialisasi store di `src/providers/auth-store-provider.tsx`:

```typescript
"use client";

import { createClient } from "@/lib/supabase/client";
import { useAuthStore } from "@/stores/auth-store";
import { Profile } from "@/types/auth";
import { ReactNode, useEffect } from "react";

export default function AuthStoreProvider({
  children,
  profile,
}: {
  children: ReactNode;
  profile: Profile;
}) {
  useEffect(() => {
    // ambil data dari supabase
    const supabase = createClient();
    supabase.auth.getUser().then(({ data: { user } }) => {
      useAuthStore.getState().setUser(user);
      useAuthStore.getState().setProfile(profile);
    });
  });

  return <>{children}</>;
}
```

**Penjelasan:**

- **Client Component**: Menggunakan `"use client"` karena menggunakan hooks
- **Props Interface**: Menerima `children` dan `profile` sebagai props
- **useEffect**: Hook untuk side effect saat component mount
- **Supabase Integration**: Mengambil user data dari Supabase auth
- **Store Update**: Update store state dengan data user dan profile

#### **Penjelasan Script Kompleks:**

**1. Store State Access Outside Component:**

```typescript
useAuthStore.getState().setUser(user);
useAuthStore.getState().setProfile(profile);
```

- `getState()`: Method untuk mengakses store state dan actions dari luar React component
- **Direct Store Call**: Tidak menggunakan hook karena di dalam useEffect callback
- **Sync Update**: Update store state secara synchronous setelah mendapat data

**2. Async Supabase Call:**

```typescript
supabase.auth.getUser().then(({ data: { user } }) => {
  useAuthStore.getState().setUser(user);
  useAuthStore.getState().setProfile(profile);
});
```

- `getUser()`: Promise yang mengembalikan user data dari session
- **Destructuring**: `{ data: { user } }` mengambil user dari nested object
- **Promise Chain**: Menggunakan `.then()` untuk handle async response

### 4. Integrasi Provider ke Layout

**Langkah:**
Mengintegrasikan AuthStoreProvider ke main layout di `src/app/layout.tsx`:

```typescript
import AuthStoreProvider from "@/providers/auth-store-provider";
import { cookies } from "next/headers";

export default async function RootLayout({
  children,
}: Readonly<{
  children: React.ReactNode;
}>) {
  const cookiesStore = await cookies();
  const profile = JSON.parse(cookiesStore.get("user_profile")?.value ?? "{}");

  return (
    <html lang="en" suppressHydrationWarning>
      <body>
        <AuthStoreProvider profile={profile}>
          <ThemeProvider>
            {children}
            <Toaster />
          </ThemeProvider>
        </AuthStoreProvider>
      </body>
    </html>
  );
}
```

**Penjelasan:**

- **Server Component**: Layout adalah server component yang bisa akses cookies
- **Cookie Parsing**: Mengambil dan parse cookie user_profile menjadi object
- **Provider Wrapping**: AuthStoreProvider membungkus semua child components
- **Data Flow**: Profile dari cookies diteruskan ke provider untuk inisialisasi store

#### **Penjelasan Script Kompleks:**

**1. Server-side Cookie Access:**

```typescript
const cookiesStore = await cookies();
const profile = JSON.parse(cookiesStore.get("user_profile")?.value ?? "{}");
```

- `await cookies()`: Async function untuk akses cookies di server component
- `?.value`: Optional chaining, jika cookie tidak ada tidak error
- `?? "{}"`: Nullish coalescing, default empty object jika cookie tidak ada
- `JSON.parse()`: Convert string cookie menjadi JavaScript object

**2. Provider Hierarchy:**

```typescript
<AuthStoreProvider profile={profile}>
  <ThemeProvider>
    {children}
    <Toaster />
  </ThemeProvider>
</AuthStoreProvider>
```

- **Nested Providers**: AuthStoreProvider di level paling luar untuk akses global
- **Props Passing**: Profile dari server component diteruskan ke client component
- **Component Tree**: Semua child components bisa akses auth store

### 5. Menggunakan Store di Component

**Langkah:**
Menggunakan auth store di sidebar component `src/components/common/app-sidebar.tsx`:

```typescript
import { useAuthStore } from "@/stores/auth-store";

export default function AppSidebar() {
  const profile = useAuthStore((state) => state.profile);

  return (
    // Component menggunakan data profile dari store
    <div>
      <h4>{profile.name}</h4>
      <p>{profile.role}</p>
    </div>
  );
}
```

**Penjelasan:**

- **Hook Usage**: `useAuthStore` hook untuk akses store state
- **State Selector**: `(state) => state.profile` untuk select hanya profile data
- **Reactive Updates**: Component otomatis re-render saat profile berubah
- **Type Safety**: TypeScript memastikan profile properties ada

#### **Penjelasan Script Kompleks:**

**1. Zustand Selector Pattern:**

```typescript
const profile = useAuthStore((state) => state.profile);
```

- **Selector Function**: `(state) => state.profile` hanya subscribe ke profile property
- **Performance Optimization**: Component hanya re-render jika profile berubah
- **Shallow Comparison**: Zustand menggunakan `Object.is()` untuk compare state changes

**2. Store vs Props:**

Sebelum Zustand (data hardcoded):

```typescript
const profile = {
  name: "Ryan Pranata",
  role: "admin",
  avatar_url: "",
};
```

Setelah Zustand (data reactive):

```typescript
const profile = useAuthStore((state) => state.profile);
```

- **Dynamic Data**: Profile sekarang dari store yang bisa berubah
- **Global State**: Bisa diakses dari component manapun
- **Single Source of Truth**: Satu tempat untuk auth state management

## Supabase Row Level Security (RLS) Policy

Berdasarkan screenshot yang diberikan, perlu membuat policy untuk table `profiles` agar aplikasi bisa mengakses data user. Berikut urutan setup RLS:

### 1. Akses Supabase Dashboard

- Buka Supabase project dashboard
- Masuk ke menu "Authentication" > "Policies"
- Pilih table `profiles`

### 2. Membuat RLS Policy

Langkah-langkah:

1. Klik "Create policy"
2. Pilih template "Enable read access for all users"
3. Konfigurasi policy:
   - **Policy Name**: "Enable read access for all users"
   - **Policy Behavior**: Permissive
   - **Policy Command**: SELECT
   - **Target Roles**: public
   - **Using Expression**: `true` (atau kondisi sesuai kebutuhan)

### 3. Policy SQL Generated

```sql
create policy "Enable read access for all users"
on "public"."profiles"
as PERMISSIVE
for SELECT
to public
using ( true );
```

**Penjelasan:**

- **SELECT Permission**: Policy ini memberikan akses read untuk semua user
- **Public Access**: Semua user (authenticated/unauthenticated) bisa read data profiles
- **Using Clause**: `true` berarti tidak ada kondisi khusus, semua record bisa diakses

**Catatan Keamanan:**
Untuk production, sebaiknya policy dibatasi hanya untuk authenticated users:

```sql
using ( auth.role() = 'authenticated' )
```

---

**Kesimpulan:**
Perubahan ini menambahkan sistem state management menggunakan Zustand untuk mengelola authentication state secara global. Auth store menyimpan data user dan profile yang bisa diakses dari component manapun, plus setup RLS policy untuk akses database yang aman.

### **Fitur State Management yang Dibuat:**

- **Global Auth State**: Store untuk user dan profile data yang accessible globally
- **Type Safety**: Full TypeScript support dengan interface dan type definitions
- **Provider Pattern**: AuthStoreProvider untuk inisialisasi store dengan server data
- **Performance Optimized**: Selector pattern untuk efficient re-rendering
- **Server Integration**: Seamless integration dengan server-side cookie data
- **RLS Security**: Database access policy untuk secure data fetching

---

_Catatan: Zustand memberikan state management yang lebih sederhana dibanding Redux, perfect untuk aplikasi POS dengan kebutuhan state yang tidak terlalu kompleks._
