# 6. Fetch Data TanStack React Query

## Recap Perubahan

### 1. Instalasi TanStack React Query

**Langkah:**
Melakukan instalasi package TanStack React Query untuk data fetching:

```bash
npm install @tanstack/react-query
```

### 2. Membuat React Query Provider

**Langkah:**
Membuat provider untuk React Query di `src/providers/react-query-provider.tsx`:

```typescript
"use client";

import { ReactNode } from "react";
import { QueryClientProvider, QueryClient } from "@tanstack/react-query";

export default function ReactQueryProvider({
  children,
}: {
  children: ReactNode;
}) {
  const client = new QueryClient({
    defaultOptions: {
      queries: {
        refetchOnWindowFocus: false,
        refetchOnReconnect: false,
        refetchOnMount: false,
        retry: false,
      },
    },
  });

  return <QueryClientProvider client={client}>{children}</QueryClientProvider>;
}
```

**Penjelasan:**

- **Client Component**: Menggunakan `"use client"` karena React Query perlu browser environment
- **QueryClient**: Instance client untuk mengelola cache dan configuration
- **Default Options**: Konfigurasi global untuk semua queries
- **Provider Pattern**: Membungkus aplikasi untuk akses React Query hooks

#### **Penjelasan Script Kompleks:**

**1. QueryClient Configuration:**

```typescript
const client = new QueryClient({
  defaultOptions: {
    queries: {
      refetchOnWindowFocus: false,
      refetchOnReconnect: false,
      refetchOnMount: false,
      retry: false,
    },
  },
});
```

- `refetchOnWindowFocus: false`: Tidak refetch saat user kembali ke tab
- `refetchOnReconnect: false`: Tidak refetch saat internet connection kembali
- `refetchOnMount: false`: Tidak refetch saat component mount ulang
- `retry: false`: Tidak retry otomatis saat query error (untuk development)

**2. Provider Wrapper Pattern:**

```typescript
return <QueryClientProvider client={client}>{children}</QueryClientProvider>;
```

- `QueryClientProvider`: Context provider dari React Query
- `client`: Instance QueryClient yang sudah dikonfigurasi
- `{children}`: Semua component di bawahnya bisa akses React Query hooks

### 3. Integrasi Provider ke Layout

**Langkah:**
Mengintegrasikan ReactQueryProvider ke main layout di `src/app/layout.tsx`:

```typescript
import ReactQueryProvider from "@/providers/react-query-provider";

export default async function RootLayout({
  children,
}: Readonly<{
  children: React.ReactNode;
}>) {
  // ... cookie parsing code

  return (
    <html lang="en" suppressHydrationWarning>
      <body>
        <ReactQueryProvider>
          <AuthStoreProvider profile={profile}>
            <ThemeProvider>
              {children}
              <Toaster />
            </ThemeProvider>
          </AuthStoreProvider>
        </ReactQueryProvider>
      </body>
    </html>
  );
}
```

**Penjelasan:**

- **Provider Order**: ReactQueryProvider di level paling luar untuk akses global
- **Nested Providers**: AuthStore di dalam ReactQuery untuk bisa menggunakan queries di auth logic
- **Server Component**: Layout tetap server component, hanya provider yang client

#### **Penjelasan Script Kompleks:**

**1. Provider Hierarchy Importance:**

```typescript
<ReactQueryProvider>          // Level 1: Data fetching layer
  <AuthStoreProvider>         // Level 2: Auth state management
    <ThemeProvider>           // Level 3: UI theme management
      {children}              // Level 4: Application pages
    </ThemeProvider>
  </AuthStoreProvider>
</ReactQueryProvider>
```

- **Layer Separation**: Setiap provider handle concern yang berbeda
- **Dependency Order**: ReactQuery pertama karena auth store mungkin perlu fetch data
- **Context Access**: Child components bisa akses semua parent contexts

### 4. Instalasi ShadCN Dialog Component

**Langkah:**
Menginstall dialog component dari ShadCN UI:

```bash
npx shadcn@latest add dialog
```

### 5. Membuat User Management Page

**Langkah:**
Membuat halaman user management di `src/app/(dashboard)/admin/user/page.tsx`:

```typescript
import UserManagement from "./_components/user";

export const metadata = {
  title: "Ryan Cafe | User Management",
};

export default function UserManagementPage() {
  return <UserManagement />;
}
```

**Penjelasan:**

- **Server Component**: Page adalah server component untuk SEO dan metadata
- **Metadata Export**: Mengset title untuk tab browser
- **Component Delegation**: Logic utama dipisah ke component terpisah
- **File-based Routing**: Next.js App Router otomatis buat route dari folder structure

### 6. Membuat User Management Component

**Langkah:**
Membuat component untuk user management di `src/app/(dashboard)/admin/user/_components/user.tsx`:

```typescript
"use client";

import { Button } from "@/components/ui/button";
import { Dialog, DialogTrigger } from "@/components/ui/dialog";
import { Input } from "@/components/ui/input";
import { createClient } from "@/lib/supabase/client";
import { useQuery } from "@tanstack/react-query";
import { toast } from "sonner";

export default function UserManagement() {
  const supabase = createClient();

  const { data: users, isLoading } = useQuery({
    queryKey: ["users"],
    queryFn: async () => {
      const { data, error } = await supabase
        .from("profiles")
        .select("*", {
          count: "exact",
        })
        .order("created_at");

      if (error) {
        toast.error("Get User Data Failed", {
          description: error.message,
        });
      }

      return data;
    },
  });

  return (
    <div className="w-full">
      <div className="mb-4 flex w-full flex-col justify-between gap-2 lg:flex-row">
        <h1 className="text-2xl font-bold">User Management</h1>
        <div className="flex gap-2">
          <Input placeholder="Search by Name" />
          <Dialog>
            <DialogTrigger asChild>
              <Button variant="outline">Create</Button>
            </DialogTrigger>
          </Dialog>
        </div>
      </div>

      {/* mapping data user */}
      {users?.map((user) => (
        <div key={user.id}>
          <h2>{user.name}</h2>
          <h2>{user.role}</h2>
        </div>
      ))}
    </div>
  );
}
```

**Penjelasan:**

- **Client Component**: Menggunakan `"use client"` untuk React Query hooks
- **useQuery Hook**: Hook untuk data fetching dengan caching otomatis
- **Supabase Integration**: Fetch data dari table profiles dengan ordering
- **Error Handling**: Toast notification saat terjadi error
- **Responsive Layout**: Flexbox layout yang responsive untuk mobile/desktop

#### **Penjelasan Script Kompleks:**

**1. React Query useQuery Pattern:**

```typescript
const { data: users, isLoading } = useQuery({
  queryKey: ["users"],
  queryFn: async () => {
    // Supabase query logic
  },
});
```

- `queryKey: ["users"]`: Unique identifier untuk cache entry
- `queryFn`: Async function yang mengembalikan data
- `data: users`: Destructure data dan rename menjadi users
- `isLoading`: Boolean state untuk loading indicator

**2. Supabase Query Builder:**

```typescript
const { data, error } = await supabase
  .from("profiles")
  .select("*", {
    count: "exact",
  })
  .order("created_at");
```

- `from("profiles")`: Pilih table profiles
- `select("*", { count: "exact" })`: Select semua columns dan hitung total rows
- `order("created_at")`: Sort berdasarkan waktu dibuat (ascending)
- **Destructuring**: `{ data, error }` dari Supabase response

**3. Error Handling Best Practice:**

```typescript
if (error) {
  toast.error("Get User Data Failed", {
    description: error.message,
  });
}

return data;
```

- **Conditional Error Check**: Cek error sebelum return data
- **User Feedback**: Toast notification untuk user experience
- **Always Return**: Selalu return data (bisa null) untuk React Query consistency

**4. Conditional Rendering dengan Optional Chaining:**

```typescript
{users?.map((user) => (
  <div key={user.id}>
    <h2>{user.name}</h2>
    <h2>{user.role}</h2>
  </div>
))}
```

- `users?.map()`: Optional chaining untuk prevent error jika users null/undefined
- `key={user.id}`: React key untuk list optimization
- **Safe Access**: Tidak error meski data belum loaded

### 7. Responsive Layout Design

**Langkah:**
Membuat responsive header dengan search dan create button:

```typescript
<div className="mb-4 flex w-full flex-col justify-between gap-2 lg:flex-row">
  <h1 className="text-2xl font-bold">User Management</h1>
  <div className="flex gap-2">
    <Input placeholder="Search by Name" />
    <Dialog>
      <DialogTrigger asChild>
        <Button variant="outline">Create</Button>
      </DialogTrigger>
    </Dialog>
  </div>
</div>
```

**Penjelasan:**

- **Responsive Flexbox**: `flex-col lg:flex-row` untuk mobile vertical, desktop horizontal
- **Space Between**: `justify-between` untuk space title dan actions
- **Gap Spacing**: `gap-2` untuk consistent spacing antar elements
- **Button Variants**: `variant="outline"` untuk styling yang konsisten

---

**Kesimpulan:**
Perubahan ini menambahkan sistem data fetching menggunakan TanStack React Query untuk mengelola server state dengan caching otomatis. User management page bisa fetch dan display data users dari Supabase dengan error handling yang proper dan UI yang responsive.

---

_Catatan: TanStack React Query memberikan caching otomatis, background refetch, dan optimistic updates yang membuat aplikasi lebih performant dan user experience yang lebih baik._
